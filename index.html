<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Experience Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 50px;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .summary h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .summary-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .summary-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .summary-item p {
            color: #666;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Developer Experience Dashboard</h1>
            <p>Analisi in tempo reale della soddisfazione degli sviluppatori</p>
            
            <!-- Filtro per anno -->
            <div style="margin-top: 20px;">
                <select id="yearFilter" style="padding: 10px 20px; border-radius: 25px; border: 2px solid white; background: rgba(255,255,255,0.9); font-size: 1rem; color: #333; cursor: pointer;">
                    <option value="all">Tutti gli anni</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading">
            <div style="font-size: 2rem; margin-bottom: 20px;">‚è≥</div>
            Caricamento dati dal Google Sheets...
        </div>

        <div id="error" class="error" style="display: none;">
            Errore nel caricamento dei dati. Assicurati che il CSV sia accessibile pubblicamente.
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">Risposte Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSatisfaction">0</div>
                    <div class="stat-label">Soddisfazione Media</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mostCommonRole">-</div>
                    <div class="stat-label">Ruolo Pi√π Comune</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mostCommonExp">-</div>
                    <div class="stat-label">Esperienza Pi√π Comune</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Distribuzione per Ruolo</div>
                    <div class="chart-wrapper">
                        <canvas id="roleChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Distribuzione per Esperienza</div>
                    <div class="chart-wrapper">
                        <canvas id="experienceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Livelli di Soddisfazione</div>
                    <div class="chart-wrapper">
                        <canvas id="satisfactionChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Soddisfazione Media per Ruolo</div>
                    <div class="chart-wrapper">
                        <canvas id="satisfactionByRoleChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Trend Soddisfazione per Anno</div>
                    <div class="chart-wrapper">
                        <canvas id="yearlyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="summary">
                <h2>üìä Sintesi dei Dati</h2>
                <div class="summary-grid" id="summaryContent">
                    <!-- Contenuto generato dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL del CSV (sostituisci con il tuo URL di Google Sheets)
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/export?format=csv&gid=0';
        
        // Dati di esempio per testing (rimuovi quando hai il CSV reale)
        const SAMPLE_DATA = [
            { ruolo: 'Frontend Developer', esperienza: '2-3 anni', soddisfazione: '4', anno: '2023' },
            { ruolo: 'Backend Developer', esperienza: '4-5 anni', soddisfazione: '5', anno: '2023' },
            { ruolo: 'Full Stack Developer', esperienza: '6-10 anni', soddisfazione: '3', anno: '2023' },
            { ruolo: 'DevOps Engineer', esperienza: '4-5 anni', soddisfazione: '4', anno: '2023' },
            { ruolo: 'Tech Lead', esperienza: '11-15 anni', soddisfazione: '5', anno: '2023' },
            { ruolo: 'Frontend Developer', esperienza: '0-1 anni', soddisfazione: '3', anno: '2024' },
            { ruolo: 'Backend Developer', esperienza: '2-3 anni', soddisfazione: '4', anno: '2024' },
            { ruolo: 'Full Stack Developer', esperienza: '4-5 anni', soddisfazione: '4', anno: '2024' },
            { ruolo: 'Mobile Developer', esperienza: '6-10 anni', soddisfazione: '5', anno: '2024' },
            { ruolo: 'QA Engineer', esperienza: '2-3 anni', soddisfazione: '3', anno: '2024' },
            { ruolo: 'Frontend Developer', esperienza: '4-5 anni', soddisfazione: '5', anno: '2024' },
            { ruolo: 'DevOps Engineer', esperienza: '6-10 anni', soddisfazione: '4', anno: '2024' },
            { ruolo: 'Designer', esperienza: '2-3 anni', soddisfazione: '4', anno: '2025' },
            { ruolo: 'Product Manager', esperienza: '6-10 anni', soddisfazione: '3', anno: '2025' },
            { ruolo: 'Data Engineer', esperienza: '4-5 anni', soddisfazione: '5', anno: '2025' },
            { ruolo: 'Frontend Developer', esperienza: '2-3 anni', soddisfazione: '5', anno: '2025' },
            { ruolo: 'Backend Developer', esperienza: '6-10 anni', soddisfazione: '4', anno: '2025' },
            { ruolo: 'Full Stack Developer', esperienza: '4-5 anni', soddisfazione: '4', anno: '2025' }
        ];

        let chartInstances = {};
        let allData = [];
        let filteredData = [];

        // Funzione per parsare CSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }

        // Funzione per caricare i dati
        async function loadData() {
            try {
                // Prova a caricare dal CSV
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('CSV non accessibile');
                
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.log('Usando dati di esempio:', error.message);
                // Usa dati di esempio per il testing
                return SAMPLE_DATA;
            }
        }

        // Funzione per filtrare dati per anno
        function filterDataByYear(data, year) {
            if (year === 'all') return data;
            return data.filter(item => item.anno === year);
        }

        // Funzione per popolare il filtro anni
        function populateYearFilter(data) {
            const years = [...new Set(data.map(item => item.anno))].sort();
            const yearFilter = document.getElementById('yearFilter');
            
            // Rimuovi opzioni esistenti tranne "Tutti gli anni"
            while (yearFilter.options.length > 1) {
                yearFilter.removeChild(yearFilter.lastChild);
            }
            
            // Aggiungi opzioni per ogni anno
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Aggiungi event listener per il filtro
            yearFilter.addEventListener('change', (e) => {
                filteredData = filterDataByYear(allData, e.target.value);
                const analysis = analyzeData(filteredData);
                updateStats(analysis);
                createCharts(filteredData, analysis);
                createSummary(filteredData, analysis);
            });
        }
        // Funzioni di analisi dati
        function analyzeData(data) {
            const totalResponses = data.length;
            
            // Soddisfazione media
            const avgSatisfaction = totalResponses > 0 ? 
                (data.reduce((sum, item) => sum + parseInt(item.soddisfazione), 0) / totalResponses).toFixed(1) : '0';
            
            // Ruolo pi√π comune
            const roleCounts = {};
            data.forEach(item => {
                roleCounts[item.ruolo] = (roleCounts[item.ruolo] || 0) + 1;
            });
            const mostCommonRole = Object.keys(roleCounts).length > 0 ? 
                Object.keys(roleCounts).reduce((a, b) => roleCounts[a] > roleCounts[b] ? a : b) : '-';
            
            // Esperienza pi√π comune
            const expCounts = {};
            data.forEach(item => {
                expCounts[item.esperienza] = (expCounts[item.esperienza] || 0) + 1;
            });
            const mostCommonExp = Object.keys(expCounts).length > 0 ? 
                Object.keys(expCounts).reduce((a, b) => expCounts[a] > expCounts[b] ? a : b) : '-';
            
            return {
                totalResponses,
                avgSatisfaction,
                mostCommonRole,
                mostCommonExp,
                roleCounts,
                expCounts
            };
        }

        // Funzione per aggiornare le statistiche
        function updateStats(analysis) {
            document.getElementById('totalResponses').textContent = analysis.totalResponses;
            document.getElementById('avgSatisfaction').textContent = analysis.avgSatisfaction + '/5';
            document.getElementById('mostCommonRole').textContent = analysis.mostCommonRole.split(' ')[0];
            document.getElementById('mostCommonExp').textContent = analysis.mostCommonExp;
        }

        // Funzione per creare grafici
        function createCharts(data, analysis) {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'];
            
            // Grafico distribuzione ruoli
            const roleData = Object.entries(analysis.roleCounts).map(([role, count]) => ({ role, count }));
            createChart('roleChart', {
                type: 'doughnut',
                data: {
                    labels: roleData.map(item => item.role),
                    datasets: [{
                        data: roleData.map(item => item.count),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Grafico distribuzione esperienza
            const expData = Object.entries(analysis.expCounts).map(([exp, count]) => ({ exp, count }));
            createChart('experienceChart', {
                type: 'bar',
                data: {
                    labels: expData.map(item => item.exp),
                    datasets: [{
                        data: expData.map(item => item.count),
                        backgroundColor: colors[0],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Grafico livelli soddisfazione
            const satisfactionCounts = {};
            data.forEach(item => {
                const level = item.soddisfazione;
                satisfactionCounts[level] = (satisfactionCounts[level] || 0) + 1;
            });
            
            createChart('satisfactionChart', {
                type: 'bar',
                data: {
                    labels: Object.keys(satisfactionCounts).sort(),
                    datasets: [{
                        data: Object.keys(satisfactionCounts).sort().map(level => satisfactionCounts[level]),
                        backgroundColor: colors[1],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Soddisfazione per ruolo
            const satisfactionByRole = {};
            const roleCountsForAvg = {};
            
            data.forEach(item => {
                if (!satisfactionByRole[item.ruolo]) {
                    satisfactionByRole[item.ruolo] = 0;
                    roleCountsForAvg[item.ruolo] = 0;
                }
                satisfactionByRole[item.ruolo] += parseInt(item.soddisfazione);
                roleCountsForAvg[item.ruolo]++;
            });

            const roleAvgData = Object.entries(satisfactionByRole).map(([role, total]) => ({
                role,
                avg: (total / roleCountsForAvg[role]).toFixed(1)
            }));

            createChart('satisfactionByRoleChart', {
                type: 'horizontalBar',
                data: {
                    labels: roleAvgData.map(item => item.role),
                    datasets: [{
                        data: roleAvgData.map(item => parseFloat(item.avg)),
                        backgroundColor: colors[2],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 5 }
                    }
                }
            });

            // Grafico trend annuale (solo se ci sono dati di pi√π anni)
            const yearlyData = {};
            allData.forEach(item => {
                if (!yearlyData[item.anno]) {
                    yearlyData[item.anno] = { total: 0, count: 0, responses: 0 };
                }
                yearlyData[item.anno].total += parseInt(item.soddisfazione);
                yearlyData[item.anno].count++;
                yearlyData[item.anno].responses++;
            });

            const yearlyTrendData = Object.entries(yearlyData)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([year, data]) => ({
                    year,
                    avgSatisfaction: (data.total / data.count).toFixed(1),
                    responses: data.responses
                }));

            createChart('yearlyTrendChart', {
                type: 'line',
                data: {
                    labels: yearlyTrendData.map(item => item.year),
                    datasets: [
                        {
                            label: 'Soddisfazione Media',
                            data: yearlyTrendData.map(item => parseFloat(item.avgSatisfaction)),
                            borderColor: colors[3],
                            backgroundColor: colors[3] + '20',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Numero Risposte',
                            data: yearlyTrendData.map(item => item.responses),
                            borderColor: colors[4],
                            backgroundColor: colors[4] + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Soddisfazione Media'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Numero Risposte'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Funzione helper per creare grafici
        function createChart(canvasId, config) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, config);
        }

        // Funzione per creare la sintesi
        function createSummary(data, analysis) {
            const summaryContent = document.getElementById('summaryContent');
            
            if (data.length === 0) {
                summaryContent.innerHTML = '<div class="summary-item"><h3>üìä Nessun dato disponibile</h3><p>Non ci sono dati per il filtro selezionato.</p></div>';
                return;
            }
            
            // Trova insights interessanti
            const highSatisfaction = data.filter(item => parseInt(item.soddisfazione) >= 4).length;
            const highSatisfactionPerc = ((highSatisfaction / data.length) * 100).toFixed(1);
            
            const seniorDevs = data.filter(item => 
                item.esperienza === '11-15 anni' || item.esperienza === 'Pi√π di 15 anni'
            ).length;
            
            const juniorDevs = data.filter(item => 
                item.esperienza === '0-1 anni' || item.esperienza === '2-3 anni'
            ).length;

            // Analisi per anno se filtrato
            const currentYear = document.getElementById('yearFilter').value;
            const yearText = currentYear === 'all' ? 'tutti gli anni' : `l'anno ${currentYear}`;

            summaryContent.innerHTML = `
                <div class="summary-item">
                    <h3>üéØ Soddisfazione Generale</h3>
                    <p>${highSatisfactionPerc}% degli sviluppatori √® soddisfatto o molto soddisfatto degli strumenti attuali per ${yearText} (punteggio 4-5).</p>
                </div>
                <div class="summary-item">
                    <h3>üë• Composizione del Team</h3>
                    <p>Il ruolo pi√π rappresentato √® ${analysis.mostCommonRole} con ${analysis.roleCounts[analysis.mostCommonRole] || 0} risposte per ${yearText}.</p>
                </div>
                <div class="summary-item">
                    <h3>üìà Livello di Esperienza</h3>
                    <p>Junior developers (0-3 anni): ${juniorDevs} | Senior developers (11+ anni): ${seniorDevs} per ${yearText}</p>
                </div>
                <div class="summary-item">
                    <h3>üîß Raccomandazioni</h3>
                    <p>Focus sul miglioramento degli strumenti per i ruoli con soddisfazione sotto la media di ${analysis.avgSatisfaction} per ${yearText}.</p>
                </div>
            `;
        }

        // Funzione principale
        async function initDashboard() {
            try {
                allData = await loadData();
                filteredData = [...allData];
                
                // Popola il filtro anni
                populateYearFilter(allData);
                
                const analysis = analyzeData(filteredData);
                
                // Nascondi loading, mostra dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Aggiorna UI
                updateStats(analysis);
                createCharts(filteredData, analysis);
                createSummary(filteredData, analysis);
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('Errore nel caricamento:', error);
            }
        }

        // Avvia l'applicazione
        initDashboard();

        // Aggiorna ogni 5 minuti
        setInterval(initDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>
